<%- include('./partials/header') %>

<% if(success.length > 0){ %>
    <div class="absolute top-5 left-1/2 -translate-x-1/2 p-3 rounded-md bg-blue-500 z-50">
        <span class="inline-block mt-1 mb-1 text-white"><%= success %></span>
    </div>
<% } %>

<% if(error && error.length > 0){ %>
    <div class="absolute top-5 left-1/2 -translate-x-1/2 p-3 rounded-md bg-red-500 z-50">
        <span class="inline-block mt-1 mb-1 text-white"><%= error %></span>
    </div>
<% } %>

<div class="w-full min-h-screen flex items-start px-10 py-10 gap-10">
    
    <div class="w-[20%] sticky top-24 h-fit">
        
        <div class="mb-10">
            <h3 class="text-xs font-bold uppercase tracking-widest mb-4 text-black dark:text-white">Sort By</h3>
            <form action="/shop" method="get">
                <select class="w-full border-b border-gray-300 dark:border-zinc-700 py-2 bg-transparent text-sm focus:outline-none cursor-pointer text-black dark:text-white" name="sortby" onchange="this.form.submit()">
                    <option value="newest" class="text-black" <%= sortby === 'newest' ? 'selected' : '' %>>Newest Arrivals</option>
                    <option value="popular" class="text-black" <%= sortby === 'popular' ? 'selected' : '' %>>Most Popular</option>
                </select>
                <% if (collection && collection !== 'all') { %>
                    <input type="hidden" name="collection" value="<%= collection %>">
                <% } %>
                <% if (filterby && filterby !== 'none') { %>
                    <input type="hidden" name="filterby" value="<%= filterby %>">
                <% } %>
            </form>
        </div>
        
        <div class="flex flex-col mb-10 text-sm">
            <h3 class="text-xs font-bold uppercase tracking-widest mb-4 text-black dark:text-white">Collections</h3>
            
            <a class="block mb-2 transition-colors <%= collection === 'all' ? 'font-bold text-black dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white' %>" 
               href="/shop?collection=all<%= sortby ? '&sortby=' + sortby : '' %><%= filterby && filterby !== 'none' ? '&filterby=' + filterby : '' %>">
                All Products
            </a>
            
            <a class="block mb-2 transition-colors <%= collection === 'new' ? 'font-bold text-black dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white' %>" 
               href="/shop?collection=new<%= sortby ? '&sortby=' + sortby : '' %><%= filterby && filterby !== 'none' ? '&filterby=' + filterby : '' %>">
                New Collection
            </a>
            
            <a class="block mb-2 transition-colors <%= collection === 'discounted' ? 'font-bold text-black dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white' %>" 
               href="/shop?collection=discounted<%= sortby ? '&sortby=' + sortby : '' %><%= filterby && filterby !== 'none' ? '&filterby=' + filterby : '' %>">
                Discounted
            </a>
        </div>
        
        <div class="flex flex-col text-sm">
            <h3 class="text-xs font-bold uppercase tracking-widest mb-4 text-black dark:text-white">Filter By</h3>
            
            <a class="block mb-2 transition-colors <%= filterby === 'available' ? 'font-bold text-black dark:text-white' : 'text-gray-500 dark:text-gray-400 hover:text-black dark:hover:text-white' %>" 
               href="/shop?filterby=available<%= sortby ? '&sortby=' + sortby : '' %><%= collection && collection !== 'all' ? '&collection=' + collection : '' %>">
                In Stock Only
            </a>
            
            <% if (filterby && filterby !== 'none') { %>
                <a class="block w-fit mt-4 text-xs text-red-500 border-b border-red-500 pb-0.5 hover:text-red-700" 
                   href="/shop?<%= sortby ? 'sortby=' + sortby : '' %><%= (sortby && collection && collection !== 'all') ? '&' : '' %><%= collection && collection !== 'all' ? 'collection=' + collection : '' %>">
                    Clear Filters
                </a>
            <% } %>
        </div>
    </div>
    
    <div class="w-[80%]">
        
        <% if (collection !== 'all' || filterby !== 'none') { %>
            <div class="mb-6 flex gap-2">
                <% if (collection !== 'all') { %>
                    <span class="px-4 py-1 border rounded-full text-xs font-medium uppercase tracking-wide">
                        <%= collection === 'new' ? 'New Collection' : collection %>
                    </span>
                <% } %>
                <% if (filterby !== 'none') { %>
                    <span class="px-4 py-1 border rounded-full text-xs font-medium uppercase tracking-wide">
                        <%= filterby === 'available' ? 'In Stock' : filterby %>
                    </span>
                <% } %>
            </div>
        <% } %>

        <% if (products.length === 0) { %>
            <div class="w-full h-96 flex flex-col items-center justify-center text-center">
                <h3 class="text-xl font-medium mb-2">No products found</h3>
                <p class="text-gray-500 mb-6">Try adjusting your filters</p>
                <a href="/shop" class="px-6 py-2 bg-black text-white rounded-full text-sm font-bold uppercase tracking-wide">Clear All</a>
            </div>
        <% } else { %>
            <div class="flex items-start gap-6 flex-wrap">
                <% products.forEach(function(product){ %>
                    
                    <% 
                       let cartItem = null;
                       if(typeof user !== 'undefined' && user.cart){
                           cartItem = user.cart.find(item => item.productId && item.productId.toString() === product._id.toString());
                       }
                       const isOutOfStock = !product.isAvailable || product.stock === 0;
                    %>

                    <div class="w-72 group cursor-pointer">
                        
                        <div class="w-full h-90 flex items-center justify-center relative rounded-[0.5rem] overflow-hidden transition-all duration-500" 
                             style="background-color: <%= product.bgcolor %>">
                            
                            <img class="h-[22rem] object-contain drop-shadow-sm transition-transform duration-500 group-hover:scale-105" 
                                 src="data:image/jpeg;base64,<%= product.image.toString('base64') %>" 
                                 alt="<%= product.name %>">
                            
                            <% if (isOutOfStock) { %>
                                <div class="absolute inset-0 bg-white/60 backdrop-blur-[2px] z-20 flex items-center justify-center">
                                    <span class="bg-black text-white px-4 py-2 text-xs font-bold uppercase tracking-widest rounded-full">
                                        Out of Stock
                                    </span>
                                </div>
                            <% } %>

                            <% if (!isOutOfStock) { %>
                                <div class="absolute bottom-6 w-full px-6 flex justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 translate-y-4 group-hover:translate-y-0 z-10" id="actions-<%= product._id %>">
                                    
                                    <% if (cartItem) { %>
                                        <div class="flex items-center gap-4 bg-black text-white px-4 py-2 rounded-full shadow-lg">
                                            <button onclick="updateCart(event, '<%= product._id %>', 'decrease')" class="hover:text-gray-300 transition text-lg"><i class="ri-subtract-line"></i></button>
                                            <span class="font-semibold text-sm w-4 text-center"><%= cartItem.quantity %></span>
                                            <button onclick="updateCart(event, '<%= product._id %>', 'add')" class="hover:text-gray-300 transition text-lg"><i class="ri-add-line"></i></button>
                                        </div>
                                    <% } else { %>
                                        <button onclick="updateCart(event, '<%= product._id %>', 'add')" class="flex items-center gap-2 bg-white text-black px-6 py-3 rounded-full shadow-lg hover:bg-black hover:text-white transition-colors">
                                            <span class="text-xs font-bold uppercase tracking-wider">Add to Cart</span>
                                            <i class="ri-shopping-bag-3-line"></i>
                                        </button>
                                    <% } %>

                                </div>
                            <% } %>

                            <% if (product.discount > 0 && !isOutOfStock) { %>
                                <span class="absolute top-4 left-4 bg-black/90 text-white px-3 py-1 text-[10px] font-bold uppercase tracking-widest rounded-full backdrop-blur-sm">
                                    -₹<%= product.discount %>
                                </span>
                            <% } %>
                        </div>
                        
                        <div class="mt-4 px-2">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-base font-medium text-black dark:text-white leading-tight mb-1">
                                        <%= product.name %>
                                    </h3>
                                    <% if (product.stock < 5 && !isOutOfStock) { %>
                                        <p class="text-[10px] text-red-500 font-bold uppercase tracking-wider">
                                            Only <%= product.stock %> Left
                                        </p>
                                    <% } %>
                                </div>

                                <div class="text-right">
                                    <h4 class="font-medium text-black dark:text-white">₹<%= product.price - product.discount %></h4>
                                    <% if (product.discount > 0) { %>
                                        <p class="text-xs text-gray-400 line-through decoration-gray-400">₹<%= product.price %></p>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } %>
    </div>
</div>
<script>
    async function updateCart(event, productId, action) {
        // Prevent default button behavior
        event.preventDefault();
        
        // Determine the route based on action
        const route = action === 'add' ? '/addtocart/' : '/decreaseqty/';
        
        try {
            const response = await fetch(route + productId, {
                method: 'GET',
                headers: {
                    'Accept': 'application/json', // Tell backend we want JSON
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Find the container for this product
                const container = document.getElementById(`actions-${productId}`);
                
                if (data.quantity > 0) {
                    // Update to Counter View
                    container.innerHTML = `
                        <div class="flex items-center gap-4 bg-black text-white px-4 py-2 rounded-full shadow-lg">
                            <button onclick="updateCart(event, '${productId}', 'decrease')" class="hover:text-gray-300 transition text-lg"><i class="ri-subtract-line"></i></button>
                            <span class="font-semibold text-sm w-4 text-center">${data.quantity}</span>
                            <button onclick="updateCart(event, '${productId}', 'add')" class="hover:text-gray-300 transition text-lg"><i class="ri-add-line"></i></button>
                        </div>
                    `;
                } else {
                    // Revert to Add Button View
                    container.innerHTML = `
                        <button onclick="updateCart(event, '${productId}', 'add')" class="flex items-center gap-2 bg-white text-black px-6 py-3 rounded-full shadow-lg hover:bg-black hover:text-white transition-colors">
                            <span class="text-xs font-bold uppercase tracking-wider">Add to Cart</span>
                            <i class="ri-shopping-bag-3-line"></i>
                        </button>
                    `;
                }
            } else {
                // Show error (like Out of Stock)
                alert(data.message);
            }
        } catch (error) {
            console.error('Error updating cart:', error);
        }
    }
</script>

<%- include('./partials/footer') %>