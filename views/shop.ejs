<%- include('./partials/header') %>

<% if(success.length > 0){ %>
    <div class="absolute top-5 left-1/2 -translate-x-1/2 p-3 rounded-md bg-blue-500 z-50">
        <span class="inline-block mt-1 mb-1 text-white"><%= success %></span>
    </div>
<% } %>

<% if(error && error.length > 0){ %>
    <div class="absolute top-5 left-1/2 -translate-x-1/2 p-3 rounded-md bg-red-500 z-50">
        <span class="inline-block mt-1 mb-1 text-white"><%= error %></span>
    </div>
<% } %>

<div class="w-full min-h-screen flex items-start px-10 py-10 gap-10 bg-gray-50 dark:bg-zinc-900 transition-colors duration-300">
    
    <div class="w-[20%] sticky top-24 h-fit">
        <form action="/shop" method="get" id="filterForm">
            
            <div class="mb-8">
                <h3 class="text-xs font-bold uppercase tracking-widest mb-3 text-black dark:text-white">Search</h3>
                <div class="relative">
                    <input type="text" name="search" value="<%= search %>" placeholder="Find products..." 
                           class="w-full px-3 py-2 border rounded-md text-sm bg-white dark:bg-zinc-800 dark:border-zinc-700 dark:text-white focus:outline-none focus:border-blue-500">
                    <button type="submit" class="absolute right-3 top-2.5 text-gray-400 hover:text-black dark:hover:text-white">
                        <i class="ri-search-line"></i>
                    </button>
                </div>
            </div>

            <div class="mb-8">
                <h3 class="text-xs font-bold uppercase tracking-widest mb-3 text-black dark:text-white">Sort By</h3>
                <select class="w-full border rounded-md px-2 py-2 text-sm bg-white dark:bg-zinc-800 dark:border-zinc-700 dark:text-white focus:outline-none cursor-pointer" name="sortby" onchange="this.form.submit()">
                    <option value="newest" <%= sortby === 'newest' ? 'selected' : '' %>>Newest Arrivals</option>
                    <option value="popular" <%= sortby === 'popular' ? 'selected' : '' %>>Most Popular</option>
                    <option value="price_low" <%= sortby === 'price_low' ? 'selected' : '' %>>Price: Low to High</option>
                    <option value="price_high" <%= sortby === 'price_high' ? 'selected' : '' %>>Price: High to Low</option>
                </select>
            </div>

            <div class="mb-8">
                <h3 class="text-xs font-bold uppercase tracking-widest mb-3 text-black dark:text-white">Price Range</h3>
                <div class="flex items-center gap-2 mb-3">
                    <input type="number" name="minPrice" value="<%= minPrice %>" placeholder="Min" 
                           class="w-1/2 px-2 py-1 text-sm border rounded bg-white dark:bg-zinc-800 dark:border-zinc-700 dark:text-white">
                    <span class="text-gray-400">-</span>
                    <input type="number" name="maxPrice" value="<%= maxPrice %>" placeholder="Max" 
                           class="w-1/2 px-2 py-1 text-sm border rounded bg-white dark:bg-zinc-800 dark:border-zinc-700 dark:text-white">
                </div>
                <button type="submit" class="w-full py-1 text-xs font-bold bg-black text-white dark:bg-white dark:text-black rounded hover:opacity-80 transition">
                    APPLY
                </button>
            </div>

            <div class="flex flex-col mb-8 text-sm">
                <h3 class="text-xs font-bold uppercase tracking-widest mb-4 text-black dark:text-white">Collections</h3>
                
                <a href="/shop?collection=all" class="block mb-2 <%= collection === 'all' ? 'font-bold text-black dark:text-white' : 'text-gray-500 dark:text-gray-400' %>">All Products</a>
                <a href="/shop?collection=new" class="block mb-2 <%= collection === 'new' ? 'font-bold text-black dark:text-white' : 'text-gray-500 dark:text-gray-400' %>">New Collection</a>
                <a href="/shop?collection=discounted" class="block mb-2 <%= collection === 'discounted' ? 'font-bold text-black dark:text-white' : 'text-gray-500 dark:text-gray-400' %>">Discounted</a>
                
                <input type="hidden" name="collection" value="<%= collection %>">
                <input type="hidden" name="filterby" value="<%= filterby %>">
            </div>

            <div class="flex flex-col text-sm">
                <h3 class="text-xs font-bold uppercase tracking-widest mb-4 text-black dark:text-white">Filter</h3>
                <a href="/shop?filterby=available" class="block mb-2 <%= filterby === 'available' ? 'font-bold text-black dark:text-white' : 'text-gray-500 dark:text-gray-400' %>">In Stock Only</a>
                
                <a href="/shop" class="block w-fit mt-4 text-xs text-red-500 border-b border-red-500 pb-0.5 hover:text-red-700">Clear All Filters</a>
            </div>
        </form>
    </div>
    
    <div class="w-[80%]">
        
        <% if (search || minPrice || maxPrice || collection !== 'all') { %>
            <div class="mb-6 flex gap-2 flex-wrap items-center">
                <span class="text-sm text-gray-500 mr-2">Showing <%= totalProducts %> results</span>
                
                <% if(search) { %> <span class="px-3 py-1 border rounded-full text-xs font-medium bg-gray-100 dark:bg-zinc-800 dark:text-white">Search: "<%= search %>"</span> <% } %>
                <% if(minPrice) { %> <span class="px-3 py-1 border rounded-full text-xs font-medium bg-gray-100 dark:bg-zinc-800 dark:text-white">Min: ₹<%= minPrice %></span> <% } %>
                <% if(maxPrice) { %> <span class="px-3 py-1 border rounded-full text-xs font-medium bg-gray-100 dark:bg-zinc-800 dark:text-white">Max: ₹<%= maxPrice %></span> <% } %>
            </div>
        <% } %>

        <% if (products.length === 0) { %>
            <div class="w-full h-96 flex flex-col items-center justify-center text-center">
                <div class="w-16 h-16 bg-gray-100 dark:bg-zinc-800 rounded-full flex items-center justify-center mb-4">
                    <i class="ri-search-2-line text-2xl text-gray-400"></i>
                </div>
                <h3 class="text-xl font-medium mb-2 text-black dark:text-white">No products found</h3>
                <p class="text-gray-500 mb-6">We couldn't find matches for your filters.</p>
                <a href="/shop" class="px-6 py-2 bg-black dark:bg-white text-white dark:text-black rounded-full text-sm font-bold uppercase tracking-wide">Clear All</a>
            </div>
        <% } else { %>
            <div class="flex items-start gap-6 flex-wrap">
                <% products.forEach(function(product){ %>
                    
                    <% 
                       let cartItem = null;
                       if(typeof user !== 'undefined' && user.cart){
                           cartItem = user.cart.find(item => item.productId && item.productId.toString() === product._id.toString());
                       }
                       const isOutOfStock = !product.isAvailable || product.stock === 0;
                    %>

                    <div class="w-72 group cursor-pointer">
                        <div class="w-full h-90 flex items-center justify-center relative rounded-[0.5rem] overflow-hidden transition-all duration-500" 
                             style="background-color: <%= product.bgcolor %>">
                            
                            <img class="h-[22rem] object-contain drop-shadow-sm transition-transform duration-500 group-hover:scale-105" 
                                 src="data:image/jpeg;base64,<%= product.image.toString('base64') %>" 
                                 alt="<%= product.name %>">
                            
                            <% if (isOutOfStock) { %>
                                <div class="absolute inset-0 bg-white/60 backdrop-blur-[2px] z-20 flex items-center justify-center">
                                    <span class="bg-black text-white px-4 py-2 text-xs font-bold uppercase tracking-widest rounded-full">Out of Stock</span>
                                </div>
                            <% } %>

                            <% if (!isOutOfStock) { %>
                                <div class="absolute bottom-6 w-full px-6 flex justify-center opacity-0 group-hover:opacity-100 transition-all duration-300 translate-y-4 group-hover:translate-y-0 z-10" id="actions-<%= product._id %>">
                                    <% if (cartItem) { %>
                                        <div class="flex items-center gap-4 bg-black text-white px-4 py-2 rounded-full shadow-lg">
                                            <button onclick="updateCart(event, '<%= product._id %>', 'decrease')" class="hover:text-gray-300 transition text-lg"><i class="ri-subtract-line"></i></button>
                                            <span class="font-semibold text-sm w-4 text-center"><%= cartItem.quantity %></span>
                                            <button onclick="updateCart(event, '<%= product._id %>', 'add')" class="hover:text-gray-300 transition text-lg"><i class="ri-add-line"></i></button>
                                        </div>
                                    <% } else { %>
                                        <button onclick="updateCart(event, '<%= product._id %>', 'add')" class="flex items-center gap-2 bg-white text-black px-6 py-3 rounded-full shadow-lg hover:bg-black hover:text-white transition-colors">
                                            <span class="text-xs font-bold uppercase tracking-wider">Add to Cart</span>
                                            <i class="ri-shopping-bag-3-line"></i>
                                        </button>
                                    <% } %>
                                </div>
                            <% } %>

                            <% if (product.discount > 0 && !isOutOfStock) { %>
                                <span class="absolute top-4 left-4 bg-black/90 text-white px-3 py-1 text-[10px] font-bold uppercase tracking-widest rounded-full backdrop-blur-sm">
                                    -₹<%= product.discount %>
                                </span>
                            <% } %>
                        </div>
                        
                        <div class="mt-4 px-2">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-base font-medium text-black dark:text-white leading-tight mb-1"><%= product.name %></h3>
                                    <% if (product.stock < 5 && !isOutOfStock) { %>
                                        <p class="text-[10px] text-red-500 font-bold uppercase tracking-wider">Only <%= product.stock %> Left</p>
                                    <% } %>
                                </div>
                                <div class="text-right">
                                    <h4 class="font-medium text-black dark:text-white">₹<%= product.price - product.discount %></h4>
                                    <% if (product.discount > 0) { %>
                                        <p class="text-xs text-gray-400 line-through decoration-gray-400">₹<%= product.price %></p>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>

            <% if (totalPages > 1) { %>
                <div class="mt-12 flex justify-center gap-2">
                    <% 
                        function getPageLink(pageNum) {
                            let params = new URLSearchParams();
                            if(search) params.append('search', search);
                            if(sortby) params.append('sortby', sortby);
                            if(collection !== 'all') params.append('collection', collection);
                            if(filterby !== 'none') params.append('filterby', filterby);
                            if(minPrice) params.append('minPrice', minPrice);
                            if(maxPrice) params.append('maxPrice', maxPrice);
                            params.append('page', pageNum);
                            return '/shop?' + params.toString();
                        }
                    %>

                    <% if (currentPage > 1) { %>
                        <a href="<%= getPageLink(currentPage - 1) %>" class="px-4 py-2 bg-white dark:bg-zinc-800 border dark:border-zinc-700 rounded-md hover:bg-gray-50 dark:hover:bg-zinc-700 text-black dark:text-white">Previous</a>
                    <% } %>

                    <% for(let i = 1; i <= totalPages; i++) { %>
                        <a href="<%= getPageLink(i) %>" class="px-4 py-2 border dark:border-zinc-700 rounded-md <%= currentPage === i ? 'bg-black text-white dark:bg-white dark:text-black font-bold' : 'bg-white dark:bg-zinc-800 text-black dark:text-white hover:bg-gray-50 dark:hover:bg-zinc-700' %>">
                            <%= i %>
                        </a>
                    <% } %>

                    <% if (currentPage < totalPages) { %>
                        <a href="<%= getPageLink(currentPage + 1) %>" class="px-4 py-2 bg-white dark:bg-zinc-800 border dark:border-zinc-700 rounded-md hover:bg-gray-50 dark:hover:bg-zinc-700 text-black dark:text-white">Next</a>
                    <% } %>
                </div>
            <% } %>

        <% } %>
    </div>
</div>

<script>
    async function updateCart(event, productId, action) {
        event.preventDefault();
        const route = action === 'add' ? '/addtocart/' : '/decreaseqty/';
        try {
            const response = await fetch(route + productId, {
                method: 'GET',
                headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }
            });
            const data = await response.json();
            if (data.success) {
                const container = document.getElementById(`actions-${productId}`);
                if (data.quantity > 0) {
                    container.innerHTML = `
                        <div class="flex items-center gap-4 bg-black text-white px-4 py-2 rounded-full shadow-lg">
                            <button onclick="updateCart(event, '${productId}', 'decrease')" class="hover:text-gray-300 transition text-lg"><i class="ri-subtract-line"></i></button>
                            <span class="font-semibold text-sm w-4 text-center">${data.quantity}</span>
                            <button onclick="updateCart(event, '${productId}', 'add')" class="hover:text-gray-300 transition text-lg"><i class="ri-add-line"></i></button>
                        </div>`;
                } else {
                    container.innerHTML = `
                        <button onclick="updateCart(event, '${productId}', 'add')" class="flex items-center gap-2 bg-white text-black px-6 py-3 rounded-full shadow-lg hover:bg-black hover:text-white transition-colors">
                            <span class="text-xs font-bold uppercase tracking-wider">Add to Cart</span>
                            <i class="ri-shopping-bag-3-line"></i>
                        </button>`;
                }
            } else { alert(data.message); }
        } catch (error) { console.error('Error updating cart:', error); }
    }
</script>

<%- include('./partials/footer') %>